<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#ffffff" />
  <link rel="manifest" href="./manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Gym Tracker</title>

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#ffffff;
      --text:#111;
      --muted:#666;
      --border:#e7e7e7;
      --soft:#eef0f3;
      --danger:#c62828;
      --ok:#1b5e20;
      --accent:#111;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);padding:12px 14px;padding-top:calc(12px + env(safe-area-inset-top));z-index:10}
    h1{font-size:18px;margin:0}
    main{padding:14px;padding-bottom:calc(14px + env(safe-area-inset-bottom));max-width:860px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px;margin-bottom:12px;box-shadow:0 1px 0 rgba(0,0,0,.02)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .row>*{flex:1 1 220px;min-width:180px}
    label{font-size:12px;color:#555;display:block;margin-bottom:6px}
    input,select,textarea,button,summary{font:inherit}
    input,select,textarea{width:100%;padding:11px 12px;border-radius:12px;border:1px solid #d9d9d9;background:#fff}
    input[type="date"]{appearance:none;-webkit-appearance:none;display:block}
    textarea{min-height:70px;resize:vertical}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button{border:0;border-radius:14px;padding:12px 14px;background:var(--accent);color:#fff;font-weight:800;flex:1 1 220px;cursor:pointer}
    button.secondary{background:#e9eaee;color:#111;font-weight:700}
    button.danger{background:var(--danger)}
    button.ok{background:var(--ok)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted);font-size:12px}
    .small{font-size:12px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid #eee;border-radius:14px;padding:12px}
    .item h3{margin:0 0 6px 0;font-size:15px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:var(--soft);font-size:12px;margin-right:6px;white-space:nowrap}
    .pill.ok{background:#e8f5e9}
    .pill.warn{background:#fff3e0}
    .pill.bad{background:#ffebee}
    .divider{height:1px;background:#eee;margin:12px 0}
    .targets{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:6px}
    .kpiRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .kpi{border:1px solid #eee;border-radius:14px;padding:10px;background:#fff;flex:1 1 180px;min-width:160px}
    .kpi .v{font-weight:900;font-size:16px}
    .kpi .t{color:#555;font-size:12px}

    details{border:1px solid #eee;border-radius:14px;padding:8px 10px;background:#fff}
    summary{cursor:pointer;font-weight:800;list-style:none;display:flex;align-items:center;justify-content:space-between;padding:6px 4px}
    summary::-webkit-details-marker{display:none}
    .summaryHint{font-weight:600;color:#555;font-size:12px}
    .configInner{padding:8px 2px 2px 2px}

    @media (max-width:430px){
      button{flex:1 1 100%}
      .row>*{flex:1 1 100%;min-width:0}
      input[type="date"]{width:100%}
    }
  </style>
</head>

<body>
<header><h1>üèãÔ∏è Gym Tracker (PWA offline)</h1></header>

<main>
  <div class="card" id="statusCard"></div>
  <div class="card" id="planCard"></div>

  <div class="card">
    <div class="row" style="align-items:center">
      <div style="flex:2">
        <div class="muted">Acci√≥n principal</div>
        <div style="font-weight:900;font-size:16px;margin-top:2px" id="primaryTitle">‚Äî</div>
        <div class="muted" style="margin-top:6px" id="primarySubtitle">‚Äî</div>
      </div>
      <div style="flex:1">
        <button id="primaryBtn">‚Äî</button>
        <div class="muted" style="margin-top:8px">Abr√≠ desde el icono (Safari ‚Üí Compartir ‚Üí ‚ÄúA√±adir a pantalla de inicio‚Äù).</div>
      </div>
    </div>

    <div class="divider"></div>

    <details id="configDetails">
      <summary>
        <span>‚öôÔ∏è Configuraci√≥n / Export / Backup</span>
        <span class="summaryHint">tocar para abrir</span>
      </summary>

      <div class="configInner">
        <div class="row">
          <div><label>Rutina (plantilla)</label><select id="routineSelect"></select></div>
          <div><label>Nombre visible (opcional)</label><input id="routineName" placeholder="Ej: Piernas A (cu√°driceps)" /></div>
          <div><label>Fecha (por defecto hoy)</label><input id="workoutDate" type="date" /></div>
        </div>

        <div style="height:10px"></div>

        <div class="actions">
          <button class="secondary" id="applyTemplateBtn">Aplicar plantilla</button>
          <button class="secondary" id="newBtn">Nueva sesi√≥n</button>
          <button class="secondary" id="exportBtn">Export CSV</button>
          <button class="secondary" id="backupBtn">Backup/Reset</button>
        </div>
      </div>
    </details>
  </div>

  <div class="card" id="workoutEditor" style="display:none">
    <h2 style="margin:0 0 10px 0;font-size:16px">Sesi√≥n en curso</h2>

    <div class="row">
      <div>
        <label>Ejercicio</label>
        <input id="exName" placeholder="Ej: Prensa / RDL / Jal√≥n..." list="exerciseList" />
        <datalist id="exerciseList"></datalist>
      </div>
      <div>
        <label>Grupo</label>
        <select id="exGroup">
          <option value="">‚Äî</option>
          <option>Piernas</option><option>Pecho</option><option>Espalda</option>
          <option>Hombros</option><option>B√≠ceps</option><option>Tr√≠ceps</option>
          <option>Core</option><option>Cardio</option>
        </select>
      </div>
    </div>

    <div style="height:10px"></div>
    <button class="secondary" id="addExerciseBtn">A√±adir ejercicio</button>

    <div class="divider"></div>
    <div id="exercisesArea"></div>

    <div class="divider"></div>
    <label>Notas de la sesi√≥n</label>
    <textarea id="workoutNotes" placeholder="Sue√±o, molestias (rodilla), t√©cnica, etc."></textarea>

    <div style="height:10px"></div>
    <div class="actions">
      <button class="ok" id="finishBtn">Guardar sesi√≥n ‚úÖ</button>
      <button class="danger" id="deleteWorkoutBtn">Eliminar sesi√≥n</button>
    </div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px 0;font-size:16px">Historial</h2>
    <div id="history" class="list"></div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px 0;font-size:16px">PRs (mejor peso √ó reps)</h2>
    <div id="prs" class="list"></div>
    <div class="muted">Sin 1RM: progresi√≥n segura por reps/peso manteniendo <b>RIR 1‚Äì3</b>.</div>
  </div>
</main>

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }

  const BLOCK1 = {"Piernas A (Quad)":[{"name":"Hack squat / Prensa","group":"Piernas","sets":4,"reps":"6-10","rir":"2"},{"name":"Sentadilla b√∫lgara","group":"Piernas","sets":3,"reps":"8-12","rir":"2"},{"name":"Extensi√≥n de cu√°driceps","group":"Piernas","sets":3,"reps":"12-15","rir":"1-2"},{"name":"Step-ups (opcional)","group":"Piernas","sets":2,"reps":"10-12","rir":"2-3"},{"name":"Gemelos de pie","group":"Piernas","sets":4,"reps":"8-12","rir":"1-2"}],"Torso A":[{"name":"Press banca / M√°quina","group":"Pecho","sets":3,"reps":"6-10","rir":"2"},{"name":"Jal√≥n al pecho","group":"Espalda","sets":3,"reps":"8-12","rir":"2"},{"name":"Remo cable","group":"Espalda","sets":3,"reps":"8-12","rir":"2"},{"name":"Press inclinado mancuernas","group":"Pecho","sets":2,"reps":"8-12","rir":"2"},{"name":"Elevaciones laterales","group":"Hombros","sets":3,"reps":"12-20","rir":"2"},{"name":"Tr√≠ceps cuerda","group":"Tr√≠ceps","sets":2,"reps":"10-15","rir":"2"}],"Piernas B (Posterior)":[{"name":"Peso muerto rumano","group":"Piernas","sets":4,"reps":"6-10","rir":"2"},{"name":"Curl femoral","group":"Piernas","sets":3,"reps":"10-15","rir":"1-2"},{"name":"Hip thrust","group":"Piernas","sets":3,"reps":"8-12","rir":"2"},{"name":"Back extension","group":"Piernas","sets":2,"reps":"10-15","rir":"2-3"},{"name":"Gemelos sentado","group":"Piernas","sets":4,"reps":"10-15","rir":"1-2"}],"Torso B":[{"name":"Remo m√°quina","group":"Espalda","sets":3,"reps":"6-10","rir":"2"},{"name":"Press militar mancuernas","group":"Hombros","sets":3,"reps":"6-10","rir":"2"},{"name":"Jal√≥n neutro","group":"Espalda","sets":2,"reps":"8-12","rir":"2"},{"name":"Face pulls","group":"Hombros","sets":2,"reps":"12-20","rir":"2"},{"name":"Curl b√≠ceps","group":"B√≠ceps","sets":2,"reps":"8-12","rir":"2"},{"name":"Press cerrado / Fondos asistidos","group":"Tr√≠ceps","sets":2,"reps":"8-12","rir":"2"}],"Piernas Pump (opcional)":[{"name":"Prensa ligera (tempo controlado)","group":"Piernas","sets":3,"reps":"12-20","rir":"3"},{"name":"Extensi√≥n de cu√°driceps","group":"Piernas","sets":3,"reps":"15-25","rir":"2-3"},{"name":"Curl femoral","group":"Piernas","sets":3,"reps":"12-20","rir":"2-3"},{"name":"Gemelos (pump)","group":"Piernas","sets":4,"reps":"12-20","rir":"2-3"},{"name":"Zona 2 (20-30 min)","group":"Cardio","sets":1,"reps":"","rir":""}]};
  const DELOAD = {"Piernas A (Quad)":[{"name":"Hack squat / Prensa","group":"Piernas","sets":2,"reps":"6-10","rir":"4"},{"name":"Extensi√≥n de cu√°driceps","group":"Piernas","sets":2,"reps":"12-15","rir":"4"},{"name":"Gemelos","group":"Piernas","sets":2,"reps":"10-15","rir":"4"}],"Torso A":[{"name":"Press banca / M√°quina","group":"Pecho","sets":2,"reps":"6-10","rir":"4"},{"name":"Jal√≥n al pecho","group":"Espalda","sets":2,"reps":"8-12","rir":"4"},{"name":"Elevaciones laterales","group":"Hombros","sets":2,"reps":"12-20","rir":"4"}],"Piernas B (Posterior)":[{"name":"Peso muerto rumano","group":"Piernas","sets":2,"reps":"6-10","rir":"4"},{"name":"Curl femoral","group":"Piernas","sets":2,"reps":"10-15","rir":"4"},{"name":"Gemelos","group":"Piernas","sets":2,"reps":"10-15","rir":"4"}],"Torso B":[{"name":"Remo m√°quina","group":"Espalda","sets":2,"reps":"6-10","rir":"4"},{"name":"Press militar mancuernas","group":"Hombros","sets":2,"reps":"6-10","rir":"4"},{"name":"Curl b√≠ceps","group":"B√≠ceps","sets":1,"reps":"8-12","rir":"4"}],"Piernas Pump (opcional)":[{"name":"Zona 2 (20-30 min)","group":"Cardio","sets":1,"reps":"","rir":""},{"name":"Movilidad (10 min)","group":"Core","sets":1,"reps":"","rir":""}]};
  const BLOCK2 = {"Piernas A (Quad)":[{"name":"Prensa (pies medios) / Hack","group":"Piernas","sets":4,"reps":"6-10","rir":"2"},{"name":"Split squat (m√°quina o mancuernas)","group":"Piernas","sets":3,"reps":"8-12","rir":"2"},{"name":"Extensi√≥n de cu√°driceps (pausa arriba)","group":"Piernas","sets":3,"reps":"12-15","rir":"1-2"},{"name":"Sissy / Step-ups (opcional)","group":"Piernas","sets":2,"reps":"10-12","rir":"2-3"},{"name":"Gemelos de pie","group":"Piernas","sets":4,"reps":"8-12","rir":"1-2"}],"Torso A":[{"name":"Press inclinado (m√°quina)","group":"Pecho","sets":3,"reps":"6-10","rir":"2"},{"name":"Jal√≥n al pecho","group":"Espalda","sets":3,"reps":"8-12","rir":"2"},{"name":"Remo pecho apoyado","group":"Espalda","sets":3,"reps":"8-12","rir":"2"},{"name":"Cruces en polea","group":"Pecho","sets":2,"reps":"10-15","rir":"2"},{"name":"Elevaciones laterales","group":"Hombros","sets":3,"reps":"12-20","rir":"2"},{"name":"Tr√≠ceps cuerda","group":"Tr√≠ceps","sets":2,"reps":"10-15","rir":"2"}],"Piernas B (Posterior)":[{"name":"RDL con mancuernas / barra","group":"Piernas","sets":4,"reps":"6-10","rir":"2"},{"name":"Curl femoral sentado","group":"Piernas","sets":3,"reps":"10-15","rir":"1-2"},{"name":"Hip thrust / Glute drive","group":"Piernas","sets":3,"reps":"8-12","rir":"2"},{"name":"Pull-through / Back extension","group":"Piernas","sets":2,"reps":"10-15","rir":"2-3"},{"name":"Gemelos sentado","group":"Piernas","sets":4,"reps":"10-15","rir":"1-2"}],"Torso B":[{"name":"Remo m√°quina (agarre distinto)","group":"Espalda","sets":3,"reps":"6-10","rir":"2"},{"name":"Press militar (m√°quina)","group":"Hombros","sets":3,"reps":"6-10","rir":"2"},{"name":"Dominadas asistidas / Jal√≥n neutro","group":"Espalda","sets":2,"reps":"6-10","rir":"2"},{"name":"Face pulls","group":"Hombros","sets":2,"reps":"12-20","rir":"2"},{"name":"Curl b√≠ceps (inclinado)","group":"B√≠ceps","sets":2,"reps":"8-12","rir":"2"},{"name":"Extensi√≥n tr√≠ceps overhead","group":"Tr√≠ceps","sets":2,"reps":"8-12","rir":"2"}],"Piernas Pump (opcional)":BLOCK1["Piernas Pump (opcional)"]};

  function getPlanByPhase(phase){ if (phase==="deload") return DELOAD; if (phase==="block2") return BLOCK2; return BLOCK1; }

  const KEY = "gymtracker_pwa_v5";
  const load = () => {
    const raw = localStorage.getItem(KEY);
    if (raw) return JSON.parse(raw);
    const v4 = localStorage.getItem("gymtracker_pwa_v4");
    if (v4){ const db4 = JSON.parse(v4); localStorage.setItem(KEY, JSON.stringify(db4)); return db4; }
    const v3 = localStorage.getItem("gymtracker_pwa_v3");
    if (v3){ const db3 = JSON.parse(v3); localStorage.setItem(KEY, JSON.stringify(db3)); return db3; }
    const v2 = localStorage.getItem("gymtracker_pwa_v2");
    if (v2){ const db2 = JSON.parse(v2); localStorage.setItem(KEY, JSON.stringify(db2)); return db2; }
    return { workouts: [], settings: { phase:"block1", phaseStart:null, useDay5:false, block:1 } };
  };
  const save = (data) => localStorage.setItem(KEY, JSON.stringify(data));
  let db = load();
  let currentId = null;
  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
  const todayISO = () => new Date().toISOString().slice(0,10);

  function ensureSettings(){
    db.settings = db.settings || { phase:"block1", phaseStart:null, useDay5:false, block:1 };
    if (!db.settings.phase) db.settings.phase = "block1";
    if (typeof db.settings.useDay5 !== "boolean") db.settings.useDay5 = false;
    if (!db.settings.block) db.settings.block = 1;
  }
  function daysBetween(aISO, bDate){ const a = new Date(aISO + "T00:00:00"); const b = new Date(bDate); return Math.floor((b - a) / (1000*60*60*24)); }
  function phaseWeek(){ ensureSettings(); if (!db.settings.phaseStart) return null; const diffDays = daysBetween(db.settings.phaseStart, new Date()); return Math.floor(diffDays/7) + 1; }
  function startPhase(phase){ ensureSettings(); db.settings.phase = phase; db.settings.phaseStart = todayISO(); save(db); renderAll(); }

  function planDayNameForToday(){
    ensureSettings();
    const day = new Date().getDay();
    if (day === 1) return "Piernas A (Quad)";
    if (day === 2) return "Torso A";
    if (day === 4) return "Piernas B (Posterior)";
    if (day === 5) return "Torso B";
    if (day === 6 && db.settings.useDay5) return "Piernas Pump (opcional)";
    return null;
  }

  function computePRs(workouts){
    const best = new Map();
    for (const w of workouts){
      for (const ex of (w.exercises||[])){
        for (const s of (ex.sets||[])){
          const weight = Number(s.weight||0);
          const reps = Number(s.reps||0);
          if (!weight || !reps) continue;
          const score = weight * reps;
          const key = (ex.name||"").trim().toLowerCase();
          const prev = best.get(key);
          if (!prev || score > prev.score){
            best.set(key, { name: ex.name, score, weight, reps, date: w.date });
          }
        }
      }
    }
    return Array.from(best.values()).sort((a,b)=>b.score-a.score);
  }

  function estimateWeeklyLegVolume(phase){
    const P = getPlanByPhase(phase);
    const quadA = (P["Piernas A (Quad)"]||[]).reduce((a,e)=>a + (e.group==="Piernas" ? e.sets : 0),0);
    const postB = (P["Piernas B (Posterior)"]||[]).reduce((a,e)=>a + (e.group==="Piernas" ? e.sets : 0),0);
    const pump = db.settings.useDay5 ? (P["Piernas Pump (opcional)"]||[]).reduce((a,e)=>a + (e.group==="Piernas" ? e.sets : 0),0) : 0;
    return {quadA,postB,pump,total:quadA+postB+pump};
  }

  const statusCard = document.getElementById("statusCard");
  const planCard = document.getElementById("planCard");
  const routineSelect = document.getElementById("routineSelect");
  const routineName = document.getElementById("routineName");
  const workoutDate = document.getElementById("workoutDate");
  const workoutEditor = document.getElementById("workoutEditor");
  const exName = document.getElementById("exName");
  const exGroup = document.getElementById("exGroup");
  const exercisesArea = document.getElementById("exercisesArea");
  const workoutNotes = document.getElementById("workoutNotes");
  const historyEl = document.getElementById("history");
  const prsEl = document.getElementById("prs");
  const exerciseList = document.getElementById("exerciseList");
  const primaryBtn = document.getElementById("primaryBtn");
  const primaryTitle = document.getElementById("primaryTitle");
  const primarySubtitle = document.getElementById("primarySubtitle");
  const configDetails = document.getElementById("configDetails");

  function refreshExerciseDatalist(){
    const set = new Set();
    [BLOCK1,BLOCK2,DELOAD].forEach(P=>Object.values(P).flat().forEach(e=>set.add(e.name)));
    db.workouts.forEach(w => (w.exercises||[]).forEach(e=>set.add(e.name)));
    exerciseList.innerHTML = Array.from(set).sort().map(n=>`<option value="${n}"></option>`).join("");
  }

  function renderStatus(){
    const n = db.workouts.length;
    const active = db.workouts.find(w=>w.id===currentId);
    statusCard.innerHTML = `
      <div class="row" style="align-items:center">
        <div>
          <div><span class="pill">Sesiones</span> <b>${n}</b></div>
          <div class="muted">${active ? "Editando: " + (active.routine||"Sesi√≥n") + " ("+active.date+")" : "Sin sesi√≥n activa"}</div>
        </div>
        <div class="muted small">Offline ¬∑ datos solo en tu iPhone/PC</div>
      </div>
    `;
  }

  function renderPlanCard(){
    ensureSettings();
    const wk = phaseWeek();
    const phase = db.settings.phase;
    const inPhase = wk !== null;

    const phaseLabel = phase==="block1" ? "Bloque 1 (8 semanas)" : (phase==="deload" ? "Deload (1 semana)" : "Bloque 2 (8 semanas)");
    const badge = phase==="deload" ? "warn" : "ok";
    const wkLimit = phase==="deload" ? 1 : 8;

    const wkShown = inPhase ? Math.min(wk, wkLimit) : null;
    const finished = inPhase && wk > wkLimit;

    const todayName = planDayNameForToday();
    const P = getPlanByPhase(phase);
    const todayPlan = todayName ? (P[todayName]||[]) : [];
    const vol = estimateWeeklyLegVolume(phase);

    const statusText = !inPhase
      ? `<span class="pill">Plan</span> <b>Sin iniciar</b> ¬∑ ${phaseLabel}`
      : `<span class="pill">Plan</span> <span class="pill ${badge}">${phaseLabel}</span> ¬∑ Semana <b>${wkShown}</b> / ${wkLimit} ${finished ? `<span class="pill bad">Terminado</span>`:""}`;

    const dayText = todayName ? `<b>Hoy toca:</b> ${todayName}` : `<b>Hoy:</b> descanso / libre`;
    const hint = phase==="deload"
      ? `Deload = bajar fatiga: menos series, RIR alto. Volv√©s m√°s fuerte al Bloque 2.`
      : `Regla de progreso: sub√≠ reps dentro del rango; si toc√°s el tope en todas las series, sub√≠ peso la pr√≥xima.`;

    const planLines = todayPlan.length
      ? `<div class="divider"></div>` + todayPlan.map(e=>`
          <div class="targets">
            <span class="pill">${e.group}</span>
            <div style="flex:1"><b>${e.name}</b></div>
            ${e.sets?`<span class="pill">${e.sets}√ó</span>`:""}
            ${e.reps?`<span class="pill">${e.reps}</span>`:""}
            ${e.rir?`<span class="pill">RIR ${e.rir}</span>`:""}
          </div>
        `).join("")
      : "";

    planCard.innerHTML = `
      <div class="row" style="align-items:center">
        <div style="flex:2">
          <div>${statusText}</div>
          <div class="muted" style="margin-top:6px">${dayText}</div>
          <div class="muted" style="margin-top:6px">D√≠a 5 opcional (s√°bado): <b>${db.settings.useDay5 ? "activado":"desactivado"}</b></div>
        </div>
        <div class="actions" style="flex:1;justify-content:flex-end">
          ${!inPhase ? `<button class="ok" id="startBlock1Btn">Iniciar Bloque 1</button>`:""}
          <button class="secondary" id="toggleDay5Btn">${db.settings.useDay5 ? "Desactivar d√≠a 5":"Activar d√≠a 5"}</button>
          <button id="startTodayBtn" ${todayName ? "" : "disabled"}>${todayName ? "Iniciar con plan":"Hoy sin plan"}</button>
          ${finished && phase==="block1" ? `<button class="secondary" id="startDeloadBtn">Iniciar Deload</button>`:""}
          ${finished && phase==="deload" ? `<button class="ok" id="startBlock2Btn">Iniciar Bloque 2</button>`:""}
        </div>
      </div>

      <div class="kpiRow">
        <div class="kpi"><div class="v">${vol.total}</div><div class="t">Series pierna/semana (estim.)</div></div>
        <div class="kpi"><div class="v">${vol.quadA}</div><div class="t">Piernas A (quad)</div></div>
        <div class="kpi"><div class="v">${vol.postB}</div><div class="t">Piernas B (posterior)</div></div>
        <div class="kpi"><div class="v">${vol.pump}</div><div class="t">D√≠a 5 (pump)</div></div>
      </div>

      <div class="muted" style="margin-top:10px">${hint}</div>
      ${planLines}
    `;

    const startBlock1Btn = document.getElementById("startBlock1Btn");
    if (startBlock1Btn) startBlock1Btn.addEventListener("click", ()=>startPhase("block1"));

    const startDeloadBtn = document.getElementById("startDeloadBtn");
    if (startDeloadBtn) startDeloadBtn.addEventListener("click", ()=>startPhase("deload"));

    const startBlock2Btn = document.getElementById("startBlock2Btn");
    if (startBlock2Btn) startBlock2Btn.addEventListener("click", ()=>startPhase("block2"));

    document.getElementById("toggleDay5Btn").addEventListener("click", ()=>{
      db.settings.useDay5 = !db.settings.useDay5;
      save(db);
      renderAll();
    });

    document.getElementById("startTodayBtn").addEventListener("click", ()=>{
      if (!todayName) return;
      startWorkoutFromPlan(todayName);
    });
  }

  function allTemplateKeys(){ return ["Piernas A (Quad)","Torso A","Piernas B (Posterior)","Torso B","Piernas Pump (opcional)"]; }
  function initTemplates(){ routineSelect.innerHTML = allTemplateKeys().map(k=>`<option value="${k}">${k}</option>`).join(""); }

  function startWorkoutFromPlan(dayName){
    ensureSettings();
    const plan = getPlanByPhase(db.settings.phase);
    const dayPlan = plan[dayName] || [];

    currentId = uid();
    const d = workoutDate.value || todayISO();
    const session = { id: currentId, routine: dayName, date: d, exercises: [], notes: "", phase: db.settings.phase };

    dayPlan.forEach(e=>{
      const ex = { name:e.name, group:e.group, sets:[], target:{ sets:e.sets||0, reps:e.reps||"", rir:e.rir||"" } };
      const nSets = Number(e.sets||0);
      for (let i=0;i<nSets;i++){
        ex.sets.push({ reps:"", weight:"", rir:(e.rir ? String(e.rir).split("-")[0] : "2") });
      }
      session.exercises.push(ex);
    });

    db.workouts.push(session);
    routineSelect.value = dayName;
    routineName.value = dayName;
    workoutDate.value = d;

    save(db);
    configDetails.open = false;
    renderAll();
    window.scrollTo({top:0,behavior:"smooth"});
  }

  function renderPrimaryCTA(){
    const w = db.workouts.find(x=>x.id===currentId);
    const todayName = planDayNameForToday();
    const todayText = todayName ? `Hoy toca: ${todayName}` : "Hoy: libre / descanso";

    if (!w){
      primaryTitle.textContent = todayText;
      primarySubtitle.textContent = todayName ? "Toc√° para iniciar tu sesi√≥n con el plan del d√≠a." : "Si quer√©s, eleg√≠ una plantilla en Configuraci√≥n y cre√° una sesi√≥n manual.";
      primaryBtn.textContent = todayName ? "‚ñ∂Ô∏è Iniciar con plan" : "‚ûï Crear sesi√≥n";
      primaryBtn.onclick = () => {
        if (todayName) startWorkoutFromPlan(todayName);
        else {
          const templateName = routineSelect.value || "Sesi√≥n";
          currentId = uid();
          const d = workoutDate.value || todayISO();
          const name = (routineName.value.trim() || templateName);
          db.workouts.push({ id: currentId, routine: name, date: d, exercises: [], notes: "", phase: db.settings?.phase || "" });
          save(db);
          renderAll();
          window.scrollTo({top:0,behavior:"smooth"});
        }
      };
    } else {
      primaryTitle.textContent = w.routine || "Sesi√≥n en curso";
      primarySubtitle.textContent = `${w.date} ¬∑ ${(w.exercises||[]).length} ejercicios ¬∑ toc√° para guardar`;
      primaryBtn.textContent = "üíæ Guardar sesi√≥n";
      primaryBtn.onclick = () => {
        w.routine = (routineName.value.trim() || w.routine || "Sesi√≥n");
        w.date = workoutDate.value || w.date || todayISO();
        w.notes = workoutNotes.value || "";
        save(db);
        alert("Sesi√≥n guardada ‚úÖ");
        renderAll();
      };
    }
  }

  function renderWorkoutEditor(){
    const w = db.workouts.find(x=>x.id===currentId);
    if (!w){ workoutEditor.style.display="none"; return; }
    workoutEditor.style.display="block";

    routineName.value = w.routine || "";
    workoutDate.value = w.date || todayISO();
    workoutNotes.value = w.notes || "";

    exercisesArea.innerHTML = (w.exercises||[]).map((ex, idx) => {
      const tgt = ex.target || null;
      const tgtLine = tgt ? `<div class="muted">Objetivo: <b>${tgt.sets||""}√ó</b> ${tgt.reps?`<b>${tgt.reps}</b>`:""} ${tgt.rir?`¬∑ <b>RIR ${tgt.rir}</b>`:""}</div>` : "";

      const setsHtml = (ex.sets||[]).map((s, i)=>`
        <div class="row">
          <div style="min-width:70px;flex:0"><span class="pill">#${i+1}</span></div>
          <div><label>Reps</label><input inputmode="numeric" value="${s.reps ?? ""}" data-ex="${idx}" data-set="${i}" data-k="reps"></div>
          <div><label>Peso</label><input inputmode="decimal" value="${s.weight ?? ""}" data-ex="${idx}" data-set="${i}" data-k="weight"></div>
          <div><label>RIR</label><input inputmode="decimal" value="${s.rir ?? ""}" data-ex="${idx}" data-set="${i}" data-k="rir"></div>
          <div style="align-self:flex-end;min-width:60px;flex:0">
            <button class="danger small" data-delset="1" data-ex="${idx}" data-set="${i}">X</button>
          </div>
        </div>
      `).join("");

      return `
        <div class="item">
          <div class="row" style="align-items:center">
            <div style="flex:1">
              <h3 style="margin:0">${ex.name}</h3>
              ${tgtLine}
            </div>
            <span class="pill">${ex.group||"‚Äî"}</span>
            <button class="danger small" data-delex="1" data-ex="${idx}">Eliminar</button>
          </div>
          <div class="divider"></div>
          ${setsHtml || '<div class="muted">Sin series a√∫n</div>'}
          <div style="height:8px"></div>
          <div class="actions">
            <button class="secondary small" data-addset="1" data-ex="${idx}">+ Serie</button>
            ${tgt && tgt.sets ? `<button class="secondary small" data-fillsets="1" data-ex="${idx}">Rellenar sets objetivo</button>` : ``}
          </div>
        </div>
      `;
    }).join("");

    exercisesArea.querySelectorAll("input").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const exi = Number(inp.dataset.ex);
        const si = Number(inp.dataset.set);
        const k = inp.dataset.k;
        const w = db.workouts.find(x=>x.id===currentId);
        w.exercises[exi].sets[si][k] = inp.value;
        save(db);
        renderPRs();
        renderPrimaryCTA();
      });
    });

    exercisesArea.querySelectorAll("button[data-addset]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const exi = Number(btn.dataset.ex);
        const w = db.workouts.find(x=>x.id===currentId);
        w.exercises[exi].sets = w.exercises[exi].sets || [];
        w.exercises[exi].sets.push({ reps:"", weight:"", rir:"2" });
        save(db);
        renderWorkoutEditor();
        renderPRs();
        renderPrimaryCTA();
      });
    });

    exercisesArea.querySelectorAll("button[data-fillsets]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const exi = Number(btn.dataset.ex);
        const w = db.workouts.find(x=>x.id===currentId);
        const ex = w.exercises[exi];
        const tgt = ex.target || {};
        const nSets = Number(tgt.sets||0);
        if (!nSets) return;
        ex.sets = [];
        for (let i=0;i<nSets;i++){
          ex.sets.push({ reps:"", weight:"", rir:(tgt.rir ? String(tgt.rir).split("-")[0] : "2") });
        }
        save(db);
        renderWorkoutEditor();
      });
    });

    exercisesArea.querySelectorAll("button[data-delset]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const exi = Number(btn.dataset.ex);
        const si = Number(btn.dataset.set);
        const w = db.workouts.find(x=>x.id===currentId);
        w.exercises[exi].sets.splice(si,1);
        save(db);
        renderWorkoutEditor();
        renderPRs();
        renderPrimaryCTA();
      });
    });

    exercisesArea.querySelectorAll("button[data-delex]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const exi = Number(btn.dataset.ex);
        const w = db.workouts.find(x=>x.id===currentId);
        w.exercises.splice(exi,1);
        save(db);
        renderWorkoutEditor();
        renderPRs();
        renderPrimaryCTA();
      });
    });
  }

  function renderHistory(){
    const workouts = [...db.workouts].sort((a,b)=> (b.date||"").localeCompare(a.date||""));
    historyEl.innerHTML = workouts.length ? workouts.map(w=>`
      <div class="item">
        <div class="row" style="align-items:center">
          <div style="flex:1">
            <div><b>${w.routine || "Sin nombre"}</b> ${w.phase ? `<span class="pill">${w.phase}</span>`:""}</div>
            <div class="muted">${w.date} ¬∑ ${(w.exercises||[]).length} ejercicios</div>
          </div>
          <button class="secondary small" data-open="${w.id}">Abrir</button>
        </div>
      </div>
    `).join("") : `<div class="muted">A√∫n no hay sesiones.</div>`;

    historyEl.querySelectorAll("button[data-open]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        currentId = btn.dataset.open;
        renderAll();
        window.scrollTo({top:0,behavior:"smooth"});
      });
    });
  }

  function renderPRs(){
    const prs = computePRs(db.workouts);
    prsEl.innerHTML = prs.length ? prs.slice(0,40).map(p=>`
      <div class="item">
        <div><b>${p.name}</b></div>
        <div class="muted">${p.weight} √ó ${p.reps} (score ${p.score.toFixed(1)}) ¬∑ ${p.date}</div>
      </div>
    `).join("") : `<div class="muted">Registra series con peso y reps para ver PRs.</div>`;
  }

  function renderAll(){
    renderStatus();
    renderPlanCard();
    renderWorkoutEditor();
    renderHistory();
    renderPRs();
    refreshExerciseDatalist();
    renderPrimaryCTA();
  }

  document.getElementById("applyTemplateBtn").addEventListener("click", ()=>{
    const w = db.workouts.find(x=>x.id===currentId);
    if (!w) return alert("Primero inicia una sesi√≥n (bot√≥n principal o plan).");
    ensureSettings();
    const P = getPlanByPhase(db.settings.phase);
    const t = P[routineSelect.value];
    if (!t) return;

    const existing = new Set((w.exercises||[]).map(e=>(e.name||"").toLowerCase()));
    t.forEach(e=>{
      if (!existing.has(e.name.toLowerCase())){
        w.exercises.push({ name:e.name, group:e.group, sets:[], target:{ sets:e.sets||0, reps:e.reps||"", rir:e.rir||"" } });
      }
    });
    save(db);
    renderWorkoutEditor();
    refreshExerciseDatalist();
    renderPrimaryCTA();
  });

  document.getElementById("newBtn").addEventListener("click", ()=>{
    currentId = null;
    routineName.value = "";
    workoutDate.value = todayISO();
    workoutNotes.value = "";
    renderAll();
  });

  document.getElementById("addExerciseBtn").addEventListener("click", ()=>{
    const w = db.workouts.find(x=>x.id===currentId);
    if (!w) return alert("Primero inicia una sesi√≥n (bot√≥n principal o plan).");
    const name = exName.value.trim();
    if (!name) return alert("Pon√© el nombre del ejercicio.");
    const group = exGroup.value || "";
    w.exercises.push({ name, group, sets: [] });
    exName.value = "";
    exGroup.value = "";
    save(db);
    renderWorkoutEditor();
    refreshExerciseDatalist();
    renderPrimaryCTA();
  });

  document.getElementById("finishBtn").addEventListener("click", ()=>{
    const w = db.workouts.find(x=>x.id===currentId);
    if (!w) return;
    w.notes = workoutNotes.value || "";
    w.routine = (routineName.value.trim() || w.routine || "Sesi√≥n");
    w.date = workoutDate.value || w.date || todayISO();
    save(db);
    currentId = null;
    renderAll();
    alert("Sesi√≥n guardada ‚úÖ");
  });

  document.getElementById("deleteWorkoutBtn").addEventListener("click", ()=>{
    if (!currentId) return;
    if (!confirm("¬øEliminar esta sesi√≥n?")) return;
    db.workouts = db.workouts.filter(w=>w.id!==currentId);
    save(db);
    currentId = null;
    renderAll();
  });

  document.getElementById("exportBtn").addEventListener("click", ()=>{
    const rows = [];
    rows.push(["date","routine","phase","exercise","group","set","reps","weight","rir","target_sets","target_reps","target_rir","notes"].join(","));
    for (const w of db.workouts){
      for (const ex of (w.exercises||[])){
        const tgt = ex.target || {};
        (ex.sets||[]).forEach((s,i)=>{
          rows.push([
            w.date,
            `"${(w.routine||"").replaceAll('"','""')}"`,
            `"${(w.phase||"").replaceAll('"','""')}"`,
            `"${(ex.name||"").replaceAll('"','""')}"`,
            `"${(ex.group||"").replaceAll('"','""')}"`,
            i+1, s.reps||"", s.weight||"", s.rir||"",
            tgt.sets||"", `"${(tgt.reps||"").replaceAll('"','""')}"`, `"${(tgt.rir||"").replaceAll('"','""')}"`,
            `"${(w.notes||"").replaceAll('"','""')}"`,
          ].join(","));
        });
      }
    }
    const blob = new Blob([rows.join("\n")], {type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "gymtracker_export.csv";
    a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById("backupBtn").addEventListener("click", ()=>{
    const json = JSON.stringify(db, null, 2);
    const blob = new Blob([json], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "gymtracker_backup.json";
    a.click();
    URL.revokeObjectURL(url);

    const ok = confirm("Backup descargado. ¬øQuieres resetear (borrar) todo ahora?");
    if (ok){
      db = {workouts:[], settings:{ phase:"block1", phaseStart:null, useDay5:false, block:1 }};
      save(db);
      currentId = null;
      renderAll();
    }
  });

  initTemplates();
  workoutDate.value = todayISO();
  renderAll();
</script>
</body>
</html>
